#                   version: 7.16.1 (stable)
#          factory-software: 7.5
#              total-memory: 1024.0MiB
#                       cpu: ARM64
#                 cpu-count: 4
#           total-hdd-space: 128.0MiB
#         architecture-name: arm64
#                board-name: hAP ax^2
#                  platform: MikroTik
#   installed-version: 7.16.1
# Flags: U - UNDOABLE
# Columns: ACTION, BY, POLICY, TIME
#   ACTION            BY     POLICY  TIME               
# U nat rule changed  admin  write   2024-11-06 02:19:59
# U nat rule changed  admin  write   2024-11-06 02:18:59
# U nat rule changed  admin  write   2024-11-06 02:17:59
# U nat rule changed  admin  write   2024-11-06 02:16:59
# U nat rule changed  admin  write   2024-11-06 02:15:59
# U nat rule changed  admin  write   2024-11-06 02:14:59
# U nat rule changed  admin  write   2024-11-06 02:13:59
# U nat rule changed  admin  write   2024-11-06 02:12:59
# U nat rule changed  admin  write   2024-11-06 02:11:59
# U nat rule changed  admin  write   2024-11-06 02:10:59
# U nat rule changed  admin  write   2024-11-06 02:09:59
# U nat rule changed  admin  write   2024-11-06 02:08:59
# U nat rule changed  admin  write   2024-11-06 02:07:59
# U nat rule changed  admin  write   2024-11-06 02:06:59
# U nat rule changed  admin  write   2024-11-06 02:05:59
# U nat rule changed  admin  write   2024-11-06 02:04:59
# U nat rule changed  admin  write   2024-11-06 02:03:59
# U nat rule changed  admin  write   2024-11-06 02:02:59
# U nat rule changed  admin  write   2024-11-06 02:01:59
# U nat rule changed  admin  write   2024-11-06 02:00:59
# U nat rule changed  admin  write   2024-11-06 01:59:59
# U nat rule changed  admin  write   2024-11-06 01:58:59
# U nat rule changed  admin  write   2024-11-06 01:57:59
# U nat rule changed  admin  write   2024-11-06 01:56:59
# U nat rule changed  admin  write   2024-11-06 01:55:59
# U nat rule changed  admin  write   2024-11-06 01:54:59
# U nat rule changed  admin  write   2024-11-06 01:53:59
# U nat rule changed  admin  write   2024-11-06 01:52:59
# U nat rule changed  admin  write   2024-11-06 01:51:59
# U nat rule changed  admin  write   2024-11-06 01:50:59
# U nat rule changed  admin  write   2024-11-06 01:49:59
# U nat rule changed  admin  write   2024-11-06 01:48:59
# U nat rule changed  admin  write   2024-11-06 01:47:59
# U nat rule changed  admin  write   2024-11-06 01:46:59
# U nat rule changed  admin  write   2024-11-06 01:45:59
# U nat rule changed  admin  write   2024-11-06 01:44:59
# U nat rule changed  admin  write   2024-11-06 01:43:59
# U nat rule changed  admin  write   2024-11-06 01:42:59
# U nat rule changed  admin  write   2024-11-06 01:41:59
# U nat rule changed  admin  write   2024-11-06 01:40:59
# U nat rule changed  admin  write   2024-11-06 01:39:59
# U nat rule changed  admin  write   2024-11-06 01:38:59
# U nat rule changed  admin  write   2024-11-06 01:37:59
# U nat rule changed  admin  write   2024-11-06 01:36:59
# U nat rule changed  admin  write   2024-11-06 01:35:59
# U nat rule changed  admin  write   2024-11-06 01:34:59
# U nat rule changed  admin  write   2024-11-06 01:33:59
# U nat rule changed  admin  write   2024-11-06 01:32:59
# U nat rule changed  admin  write   2024-11-06 01:31:59
# U nat rule changed  admin  write   2024-11-06 01:30:59
# U nat rule changed  admin  write   2024-11-06 01:29:59
# U nat rule changed  admin  write   2024-11-06 01:28:59
# U nat rule changed  admin  write   2024-11-06 01:27:59
# U nat rule changed  admin  write   2024-11-06 01:26:59
# U nat rule changed  admin  write   2024-11-06 01:25:59
# U nat rule changed  admin  write   2024-11-06 01:24:59
# U nat rule changed  admin  write   2024-11-06 01:23:59
# U nat rule changed  admin  write   2024-11-06 01:22:59
# U nat rule changed  admin  write   2024-11-06 01:21:59
# U nat rule changed  admin  write   2024-11-06 01:20:59
# U nat rule changed  admin  write   2024-11-06 01:19:59
# U nat rule changed  admin  write   2024-11-06 01:18:59
# U nat rule changed  admin  write   2024-11-06 01:17:59
# U nat rule changed  admin  write   2024-11-06 01:16:59
# U nat rule changed  admin  write   2024-11-06 01:15:59
# U nat rule changed  admin  write   2024-11-06 01:14:59
# U nat rule changed  admin  write   2024-11-06 01:13:59
# U nat rule changed  admin  write   2024-11-06 01:12:59
# U nat rule changed  admin  write   2024-11-06 01:11:59
# U nat rule changed  admin  write   2024-11-06 01:10:59
# U nat rule changed  admin  write   2024-11-06 01:09:59
# U nat rule changed  admin  write   2024-11-06 01:08:59
# U nat rule changed  admin  write   2024-11-06 01:07:59
# U nat rule changed  admin  write   2024-11-06 01:06:59
# U nat rule changed  admin  write   2024-11-06 01:05:59
# U nat rule changed  admin  write   2024-11-06 01:04:59
# U nat rule changed  admin  write   2024-11-06 01:03:59
# U nat rule changed  admin  write   2024-11-06 01:02:59
# U nat rule changed  admin  write   2024-11-06 01:01:59
# U nat rule changed  admin  write   2024-11-06 01:00:59
# U nat rule changed  admin  write   2024-11-06 00:59:59
# U nat rule changed  admin  write   2024-11-06 00:58:59
# U nat rule changed  admin  write   2024-11-06 00:57:59
# U nat rule changed  admin  write   2024-11-06 00:56:59
# U nat rule changed  admin  write   2024-11-06 00:55:59
# U nat rule changed  admin  write   2024-11-06 00:54:59
# U nat rule changed  admin  write   2024-11-06 00:53:59
# U nat rule changed  admin  write   2024-11-06 00:52:59
# U nat rule changed  admin  write   2024-11-06 00:51:59
# U nat rule changed  admin  write   2024-11-06 00:50:59
# U nat rule changed  admin  write   2024-11-06 00:49:59
# U nat rule changed  admin  write   2024-11-06 00:48:59
# U nat rule changed  admin  write   2024-11-06 00:47:59
# U nat rule changed  admin  write   2024-11-06 00:46:59
# U nat rule changed  admin  write   2024-11-06 00:45:59
# U nat rule changed  admin  write   2024-11-06 00:44:59
# U nat rule changed  admin  write   2024-11-06 00:43:59
# U nat rule changed  admin  write   2024-11-06 00:42:59
# U nat rule changed  admin  write   2024-11-06 00:41:59
# U nat rule changed  admin  write   2024-11-06 00:40:59
# 
# software id = 86J4-T0JT
#
# model = C52iG-5HaxD2HaxD
# serial number = HET09EDF374
/interface bridge
add name=bridge-IoT
add name=bridge-LAN
add name=bridge-WLAN
add name=loopback-MGMT protocol-mode=none
add comment="DNS Anycast" name=loopback53 protocol-mode=none
add comment="NTP Anycast" name=loopback123 protocol-mode=none
/interface ethernet
set [ find default-name=ether1 ] comment="WAN - MobinNet LTE"
set [ find default-name=ether5 ] comment=Sandogh
/interface list
add name=NoNetFlow
add exclude=NoNetFlow include=all name=NetFlow
add name=DNS_capture
/interface wifi security
add authentication-types=wpa2-psk,wpa3-psk disabled=no encryption=ccmp,gcmp,ccmp-256,gcmp-256 name="Safe Service" passphrase=Amin@sapra wps=disable
add authentication-types=wpa2-psk,wpa3-psk disabled=no encryption=ccmp,gcmp,ccmp-256,gcmp-256 name="SafeService IoT" passphrase=S@PR4io7 wps=disable
/interface wifi configuration
add disabled=no mode=ap name=WLAN security="Safe Service" ssid="Safe Service HAM"
add disabled=no mode=ap name=IoT security="SafeService IoT" ssid="SafeService IoT Network"
/interface wifi
set [ find default-name=wifi1 ] channel.band=5ghz-ax .width=20/40mhz configuration=WLAN configuration.mode=ap disabled=no
set [ find default-name=wifi2 ] channel.band=2ghz-ax .width=20mhz configuration=WLAN configuration.mode=ap disabled=no
add configuration=IoT configuration.mode=ap disabled=no mac-address=7A:9A:18:20:78:AA master-interface=wifi2 name="IoT 2.4"
add configuration=IoT configuration.mode=ap disabled=no mac-address=7A:9A:18:20:78:A9 master-interface=wifi1 name="IoT 5"
/ip ipsec proposal
set [ find default=yes ] auth-algorithms=sha512,sha256,sha1 enc-algorithms="aes-256-cbc,aes-256-ctr,aes-256-gcm,aes-192-cbc,aes-192-ctr,aes-192-gcm,aes-128-cbc,aes-128-ctr,aes-128-gcm"
/ip pool
add name=dhcp_pool_LAN ranges=172.16.83.21-172.16.83.254
add name=dhcp-WLAN ranges=172.16.84.21-172.16.84.254
add name=dhcp_pool_IoT ranges=172.16.85.21-172.16.85.254
/ip dhcp-server
add address-pool=dhcp_pool_LAN interface=bridge-LAN lease-time=2d name=dhcp-LAN
add address-pool=dhcp-WLAN interface=bridge-WLAN lease-time=2d name=dhcp-WLAN
add address-pool=dhcp_pool_IoT interface=bridge-IoT lease-time=2d name=dhcp1
/ip smb users
set [ find default=yes ] disabled=yes
/ppp profile
add change-tcp-mss=yes name=HQ use-encryption=required
/interface l2tp-client
add allow-fast-path=yes connect-to=80.210.28.192 disabled=no ipsec-secret=S@pr4min max-mru=1500 max-mtu=1500 mrru=1600 name=l2tp-AHD-AF0-R4-RTR-01 password=HAM-AF0-RF-RTR-01 profile=HQ use-ipsec=yes user=HAM-AF0-RF-RTR-01
add allow-fast-path=yes connect-to=85.198.25.40 disabled=no ipsec-secret=S@pr4min max-mru=1500 max-mtu=1500 mrru=1600 name=l2tp-AHD-CF0-R1-RTR-01 password=HAM-AF0-RF-RTR-01 profile=HQ use-ipsec=yes user=HAM-AF0-RF-RTR-01
/routing bgp template
add address-families=ip,ipv6 as=65666 disabled=no input.affinity=main multihop=yes name=HQ output.affinity=main .network=BGP_Network router-id=172.31.2.1 routing-table=main use-bfd=yes
/routing id
add disabled=no id=172.31.2.1 name=id-1 select-dynamic-id=""
/routing ospf instance
add disabled=no name=ospf-instance-1 originate-default=never out-filter-chain=ospf-out redistribute=connected,static router-id=id-1
/routing ospf area
add area-id=1.0.0.1 disabled=no instance=ospf-instance-1 name=ospf-area-1.0.0.1 nssa-translator=candidate type=nssa
/snmp community
set [ find default=yes ] addresses=172.16.0.16/32,172.16.0.24/32 name=S@Pr4NMP
/system logging action
set 0 memory-lines=5000
add name=syslog remote=172.16.0.20 remote-port=1514 src-address=172.30.16.1 target=remote
/interface bridge port
add bridge=bridge-LAN interface=ether2
add bridge=bridge-LAN interface=ether3
add bridge=bridge-LAN interface=ether4
add bridge=bridge-WLAN interface=wifi1
add bridge=bridge-WLAN interface=wifi2
add bridge=bridge-LAN interface=ether5
add bridge=bridge-IoT interface="IoT 2.4"
add bridge=bridge-IoT interface="IoT 5"
/ip firewall connection tracking
set udp-timeout=10s
/ip neighbor discovery-settings
set discover-interface-list=!dynamic
/interface list member
add interface=ether1 list=NoNetFlow
add interface=bridge-LAN list=DNS_capture
add interface=bridge-WLAN list=DNS_capture
add interface=bridge-IoT list=DNS_capture
/ip address
add address=172.30.16.1/24 interface=loopback-MGMT network=172.30.16.0
add address=172.16.83.1/24 interface=bridge-LAN network=172.16.83.0
add address=172.16.84.1/24 interface=bridge-WLAN network=172.16.84.0
add address=172.31.2.1 interface=lo network=172.31.2.1
add address=172.16.95.2/29 interface=ether1 network=172.16.95.0
add address=172.31.0.123 interface=loopback123 network=172.31.0.123
add address=172.16.85.1/24 interface=bridge-IoT network=172.16.85.0
add address=172.31.0.53 interface=loopback53 network=172.31.0.53
/ip dhcp-client
add interface=ether1 use-peer-dns=no use-peer-ntp=no
/ip dhcp-server lease
add address=172.16.83.21 client-id=1:50:af:73:3f:8e:bd mac-address=50:AF:73:3F:8E:BD server=dhcp-LAN
add address=172.16.85.254 comment=PoS mac-address=40:F5:20:CF:6C:37 server=dhcp1
/ip dhcp-server network
add address=172.16.83.0/24 comment=LAN dns-server=172.16.0.11 gateway=172.16.83.1 ntp-server=172.31.0.123
add address=172.16.84.0/24 comment=WLAN dns-server=172.16.0.11 gateway=172.16.84.1
add address=172.16.85.0/24 dns-server=172.31.0.53 gateway=172.16.85.1
/ip dns
set allow-remote-requests=yes servers=172.16.0.11
/ip dns static
add address=192.168.60.254 name=ss.user.shop type=A
add address=185.173.106.86 name=crm.sapramin.com type=A
add address=172.30.0.100 name=vcsa.sapramin.local type=A
add address=172.16.0.15 name=automation.sapramin.com type=A
add address=172.16.0.11 name=safeservice.local type=A
add address=172.16.0.11 name=ss type=A
/ip firewall address-list
add address=192.168.0.0/16 list=bogon
add address=172.16.0.0/12 list=bogon
add address=10.0.0.0/8 list=bogon
add address=0.0.0.0/8 comment=RFC6890 list=bogon
add address=169.254.0.0/16 comment=RFC6890 list=bogon
add address=127.0.0.0/8 comment=RFC6890 list=bogon
add address=224.0.0.0/4 comment=Multicast list=bogon
add address=198.18.0.0/15 comment=RFC6890 list=bogon
add address=192.0.0.0/24 comment=RFC6890 list=bogon
add address=192.0.2.0/24 comment=RFC6890 list=bogon
add address=198.51.100.0/24 comment=RFC6890 list=bogon
add address=203.0.113.0/24 comment=RFC6890 list=bogon
add address=100.64.0.0/10 comment=RFC6890 list=bogon
add address=240.0.0.0/4 comment=RFC6890 list=bogon
add address=10.0.0.0/8 list=allowed_bogon_wan
add address=172.16.85.0/24 comment="kart khan" list="ALLOW WAN ACCESS"
add address=172.16.80.0/20 comment="Hamedan supernet" list=BGP_Network
add address=172.30.16.0/24 comment=MGMT list=BGP_Network
add address=172.31.2.0/26 comment=Loopbacks list=BGP_Network
/ip firewall filter
add action=drop chain=input comment="Drop invalid input connections" connection-state=invalid
add action=drop chain=forward comment="Drop invalid connections to WAN" connection-state=invalid out-interface=ether1
add action=drop chain=forward comment="Drop invalid connections from WAN" connection-state=invalid in-interface=ether1
add action=accept chain=forward comment="WAN ACCESS CONTROL" out-interface=ether1 src-address-list="ALLOW WAN ACCESS"
add action=drop chain=forward comment="WAN ACCESS CONTROL" disabled=yes dst-address=!172.16.95.1 out-interface=ether1
/ip firewall mangle
add action=accept chain=postrouting comment="WAN ACCESS CONTROL" out-interface=ether1 src-address-list="ALLOW WAN ACCESS"
/ip firewall nat
add action=redirect chain=dstnat comment="DNS Capture" disabled=yes dst-port=53 in-interface-list=DNS_capture protocol=udp
add action=src-nat chain=srcnat comment="WAN NAT" out-interface=ether1 to-addresses=178.131.133.41
/ip firewall raw
add action=drop chain=prerouting comment="Drop DNS from WAN" dst-port=53 in-interface=ether1 protocol=udp
add action=drop chain=prerouting comment="Drop DNS from WAN" dst-port=53 in-interface=ether1 protocol=tcp
add action=drop chain=prerouting comment="Drop suspiscious/malicious sources" src-address-list=malicious
add action=drop chain=prerouting comment="Drop suspiscious/malicious destinations" dst-address-list=malicious
add action=accept chain=prerouting comment="Allow some bogon packets from WAN" in-interface=ether1 src-address-list=allowed_bogon_wan
add action=drop chain=prerouting comment="Drop bogon packets from WAN" disabled=yes in-interface=ether1 src-address-list=bogon
/ip firewall service-port
set ftp disabled=yes
set tftp disabled=yes
set h323 disabled=yes
set sip disabled=yes
set pptp disabled=yes
/ip ipsec profile
set [ find default=yes ] dpd-interval=2m dpd-maximum-failures=5
/ip route
add blackhole comment="Store supernet" disabled=no distance=1 dst-address=172.16.80.0/20 gateway="" routing-table=main scope=30 suppress-hw-offload=no target-scope=10
add blackhole comment=Loopbacks disabled=no distance=1 dst-address=172.31.2.0/26 gateway="" routing-table=main scope=30 suppress-hw-offload=no target-scope=10
add check-gateway=ping disabled=no distance=253 dst-address=172.16.0.0/12 gateway=172.29.0.0 routing-table=main scope=40 suppress-hw-offload=no target-scope=30
add disabled=no distance=254 dst-address=172.16.0.0/12 gateway=172.29.0.16 routing-table=main scope=40 suppress-hw-offload=no target-scope=30
/ip service
set telnet address=172.16.0.0/12
set ftp disabled=yes
set www disabled=yes
set api disabled=yes
set winbox port=8595
set api-ssl disabled=yes
/ip smb shares
set [ find default=yes ] directory=/pub
/ip ssh
set strong-crypto=yes
/ip traffic-flow
set active-flow-timeout=1m cache-entries=1M interfaces=NetFlow
/ip traffic-flow ipfix
set nat-dst-address=no nat-dst-port=no nat-src-address=no nat-src-port=no
/ip traffic-flow target
add dst-address=172.16.0.21 port=9995 src-address=172.30.8.1 version=ipfix
/routing bfd configuration
add disabled=no interfaces=l2tp-AHD-AF0-R4-RTR-01 min-rx=1s min-tx=1s multiplier=5
add disabled=no interfaces=l2tp-AHD-CF0-R1-RTR-01 min-rx=1s min-tx=1s multiplier=5
/routing bgp connection
add address-families=ip,ipv6 as=65666 disabled=no input.affinity=main local.address=172.29.1.0 .role=ibgp .ttl=1 multihop=yes name=AHD-AF0-R4-RTR-01 output.affinity=main .network=BGP_Network remote.address=172.29.0.0/32 .as=65666 router-id=172.31.2.1 routing-table=main tcp-md5-key=S@PR4m1N templates=HQ use-bfd=yes
add address-families=ip,ipv6 as=65666 disabled=no input.affinity=main local.address=172.29.2.0 .role=ibgp .ttl=1 multihop=yes name=AHD-CF0-R1-RTR-01 output.affinity=main .network=BGP_Network remote.address=172.29.0.16/32 .as=65666 router-id=172.31.2.1 routing-table=main tcp-md5-key=S@PR4m1N templates=HQ use-bfd=yes
/routing filter rule
add chain=ospf-out comment=Loopbacks disabled=no rule="if (protocol connected && dst in 172.31.0.0/24) {accept}"
add chain=ospf-out comment="Safe Service Hamedan summary route" disabled=no rule="if (protocol static && dst == 172.16.80.0/20) {accept}"
add chain=ospf-out comment=MGMT disabled=no rule="if (protocol connected && dst == 172.30.16.0/24) {accept}"
/routing ospf interface-template
add area=ospf-area-1.0.0.1 auth=sha256 auth-id=1 auth-key=S@PR4m1N cost=100 disabled=no interfaces=l2tp-AHD-AF0-R4-RTR-01 networks=172.29.0.0/32 type=ptp use-bfd=yes
add area=ospf-area-1.0.0.1 auth=sha256 auth-id=1 auth-key=S@PR4m1N cost=110 disabled=no interfaces=l2tp-AHD-CF0-R1-RTR-01 networks=172.29.0.16/32 type=ptp use-bfd=yes
/snmp
set contact=it@sapramin.com enabled=yes location="HAM AF0 [34.824805, 48.522649]" src-address=172.30.16.1
/system clock
set time-zone-name=Asia/Tehran
/system identity
set name=HAM-AF0-RF-RTR-01
/system logging
add action=syslog topics=critical
add action=syslog topics=warning
add action=syslog topics=info
add action=syslog topics=error
/system note
set show-at-login=no
/system ntp client
set enabled=yes
/system ntp server
set enabled=yes
/system ntp client servers
add address=time.windows.com
add address=time.google.com
add address=ir.pool.ntp.org
/system scheduler
add interval=1m name=DNS_Check on-event="/system script run DNS_Check" policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-time=startup
/system script
add dont-require-permissions=no name=DNS_Check owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source=":local PrimaryDNS \"172.16.0.11\";\r\n:local BackupDNS \"8.8.8.8,1.1.1.1,9.9.9.9\";\r\n:local TestDomain \"google.com\";\r\n\r\n:local ConfiguredDNS [/ip dns get servers];\r\n\r\n:if (\$ConfiguredDNS = \$PrimaryDNS) do={\r\n    :do {\r\n        /ip/firewall/nat/disable [find where comment=\"DNS Capture\"]\r\n        :put [:resolve \$TestDomain server \$PrimaryDNS];\r\n    } on-error={\r\n        log warning \"Primary DNS \$PrimaryDNS query failed. Setting \$BackupDNS as DNS servers\";\r\n        /ip dns set servers=\$BackupDNS;\r\n        /ip/firewall/nat/enable [find where comment=\"DNS Capture\"]\r\n    }\r\n} else={\r\n    :do {\r\n        :put [:resolve \$TestDomain server \$PrimaryDNS];\r\n        log warning \"Primary DNS \$PrimaryDNS is back online. Setting \$PrimaryDNS as DNS server\";\r\n        /ip dns set servers=\$PrimaryDNS;\r\n        /ip dns cache flush;\r\n    } on-error={ }\r\n}"
