#                   version: 7.16.1 (stable)
#          factory-software: 6.45.9
#              total-memory: 128.0MiB
#                       cpu: MIPS 74Kc V4.12
#                 cpu-count: 1
#           total-hdd-space: 128.0MiB
#         architecture-name: mipsbe
#                board-name: RB951G-2HnD
#                  platform: MikroTik
#   installed-version: 7.16.1
# Flags: U - UNDOABLE
# Columns: ACTION, BY, POLICY, TIME
#   ACTION            BY     POLICY  TIME               
# U nat rule changed  admin  write   2024-11-02 15:21:24
# U nat rule changed  admin  write   2024-11-02 15:20:24
# U nat rule changed  admin  write   2024-11-02 15:19:24
# U nat rule changed  admin  write   2024-11-02 15:18:24
# U nat rule changed  admin  write   2024-11-02 15:17:24
# U nat rule changed  admin  write   2024-11-02 15:16:24
# U nat rule changed  admin  write   2024-11-02 15:15:24
# U nat rule changed  admin  write   2024-11-02 15:14:24
# U nat rule changed  admin  write   2024-11-02 15:13:24
# U nat rule changed  admin  write   2024-11-02 15:12:24
# U nat rule changed  admin  write   2024-11-02 15:11:24
# U nat rule changed  admin  write   2024-11-02 15:10:24
# U nat rule changed  admin  write   2024-11-02 15:09:24
# U nat rule changed  admin  write   2024-11-02 15:08:24
# U nat rule changed  admin  write   2024-11-02 15:07:24
# U nat rule changed  admin  write   2024-11-02 15:06:24
# U nat rule changed  admin  write   2024-11-02 15:05:24
# U nat rule changed  admin  write   2024-11-02 15:04:24
# U nat rule changed  admin  write   2024-11-02 15:03:24
# U nat rule changed  admin  write   2024-11-02 15:02:24
# U nat rule changed  admin  write   2024-11-02 15:01:24
# U nat rule changed  admin  write   2024-11-02 15:00:24
# U nat rule changed  admin  write   2024-11-02 14:59:24
# U nat rule changed  admin  write   2024-11-02 14:58:24
# U nat rule changed  admin  write   2024-11-02 14:57:24
# U nat rule changed  admin  write   2024-11-02 14:56:24
# U nat rule changed  admin  write   2024-11-02 14:55:24
# U nat rule changed  admin  write   2024-11-02 14:54:24
# U nat rule changed  admin  write   2024-11-02 14:53:24
# U nat rule changed  admin  write   2024-11-02 14:52:24
# U nat rule changed  admin  write   2024-11-02 14:51:24
# U nat rule changed  admin  write   2024-11-02 14:50:24
# U nat rule changed  admin  write   2024-11-02 14:49:24
# U nat rule changed  admin  write   2024-11-02 14:48:24
# U nat rule changed  admin  write   2024-11-02 14:47:24
# U nat rule changed  admin  write   2024-11-02 14:46:24
# U nat rule changed  admin  write   2024-11-02 14:45:24
# U nat rule changed  admin  write   2024-11-02 14:44:24
# U nat rule changed  admin  write   2024-11-02 14:43:24
# U nat rule changed  admin  write   2024-11-02 14:42:24
# U nat rule changed  admin  write   2024-11-02 14:41:24
# U nat rule changed  admin  write   2024-11-02 14:40:24
# U nat rule changed  admin  write   2024-11-02 14:39:24
# U nat rule changed  admin  write   2024-11-02 14:38:24
# U nat rule changed  admin  write   2024-11-02 14:37:24
# U nat rule changed  admin  write   2024-11-02 14:36:24
# U nat rule changed  admin  write   2024-11-02 14:35:24
# U nat rule changed  admin  write   2024-11-02 14:34:24
# U nat rule changed  admin  write   2024-11-02 14:33:24
# U nat rule changed  admin  write   2024-11-02 14:32:24
# U nat rule changed  admin  write   2024-11-02 14:31:24
# U nat rule changed  admin  write   2024-11-02 14:30:24
# U nat rule changed  admin  write   2024-11-02 14:29:24
# U nat rule changed  admin  write   2024-11-02 14:28:24
# U nat rule changed  admin  write   2024-11-02 14:27:24
# U nat rule changed  admin  write   2024-11-02 14:26:24
# U nat rule changed  admin  write   2024-11-02 14:25:24
# U nat rule changed  admin  write   2024-11-02 14:24:24
# U nat rule changed  admin  write   2024-11-02 14:23:24
# U nat rule changed  admin  write   2024-11-02 14:22:24
# U nat rule changed  admin  write   2024-11-02 14:21:24
# U nat rule changed  admin  write   2024-11-02 14:20:24
# U nat rule changed  admin  write   2024-11-02 14:19:24
# U nat rule changed  admin  write   2024-11-02 14:18:24
# U nat rule changed  admin  write   2024-11-02 14:17:24
# U nat rule changed  admin  write   2024-11-02 14:16:24
# U nat rule changed  admin  write   2024-11-02 14:15:24
# U nat rule changed  admin  write   2024-11-02 14:14:24
# U nat rule changed  admin  write   2024-11-02 14:13:24
# U nat rule changed  admin  write   2024-11-02 14:12:24
# U nat rule changed  admin  write   2024-11-02 14:11:24
# U nat rule changed  admin  write   2024-11-02 14:10:24
# U nat rule changed  admin  write   2024-11-02 14:09:24
# U nat rule changed  admin  write   2024-11-02 14:08:24
# U nat rule changed  admin  write   2024-11-02 14:07:24
# U nat rule changed  admin  write   2024-11-02 14:06:24
# U nat rule changed  admin  write   2024-11-02 14:05:24
# U nat rule changed  admin  write   2024-11-02 14:04:24
# U nat rule changed  admin  write   2024-11-02 14:03:24
# U nat rule changed  admin  write   2024-11-02 14:02:24
# U nat rule changed  admin  write   2024-11-02 14:01:24
# U nat rule changed  admin  write   2024-11-02 14:00:24
# U nat rule changed  admin  write   2024-11-02 13:59:24
# U nat rule changed  admin  write   2024-11-02 13:58:24
# U nat rule changed  admin  write   2024-11-02 13:57:24
# U nat rule changed  admin  write   2024-11-02 13:56:24
# U nat rule changed  admin  write   2024-11-02 13:55:24
# U nat rule changed  admin  write   2024-11-02 13:54:24
# U nat rule changed  admin  write   2024-11-02 13:53:24
# U nat rule changed  admin  write   2024-11-02 13:52:24
# U nat rule changed  admin  write   2024-11-02 13:51:24
# U nat rule changed  admin  write   2024-11-02 13:50:24
# U nat rule changed  admin  write   2024-11-02 13:49:24
# U nat rule changed  admin  write   2024-11-02 13:48:24
# U nat rule changed  admin  write   2024-11-02 13:47:24
# U nat rule changed  admin  write   2024-11-02 13:46:24
# U nat rule changed  admin  write   2024-11-02 13:45:24
# U nat rule changed  admin  write   2024-11-02 13:44:24
# U nat rule changed  admin  write   2024-11-02 13:43:24
# U nat rule changed  admin  write   2024-11-02 13:42:24
# 
# software id = GMXK-3L5N
#
# model = RB951G-2HnD
# serial number = DE350DFE067B
/interface bridge
add name=MGMT port-cost-mode=short
add name=bridge-LAN port-cost-mode=short
add name=loopback1 port-cost-mode=short protocol-mode=none
add name=loopback53 protocol-mode=none
add name=loopback123 protocol-mode=none
/interface wireless
set [ find default-name=wlan1 ] adaptive-noise-immunity=ap-and-client-mode band=2ghz-onlyn basic-rates-a/g="" basic-rates-b="" country=iran disabled=no distance=indoors frequency-mode=superchannel guard-interval=long ht-basic-mcs=mcs-0,mcs-1,mcs-2,mcs-3 ht-supported-mcs=mcs-0,mcs-1,mcs-2,mcs-3,mcs-8,mcs-9,mcs-10,mcs-11 installation=indoor mode=ap-bridge ssid=Safe station-roaming=enabled supported-rates-a/g="" supported-rates-b="" wireless-protocol=802.11 wmm-support=enabled wps-mode=disabled
/interface ethernet
set [ find default-name=ether1 ] comment="Baran Boushehri PC"
set [ find default-name=ether2 ] comment="Ehsan Falahati PC"
set [ find default-name=ether3 ] comment=Dahua
set [ find default-name=ether5 ] comment="WAN - T0-Radio-NET"
/interface pppoe-client
add add-default-route=yes default-route-distance=5 disabled=no interface=ether5 name=Radio password=tnWycpqp user=wifi3490256220
/interface gre
add disabled=yes local-address=109.238.189.245 mtu=1400 name=to-ahmadabad remote-address=80.210.28.192
/interface list
add name=NotNetFlow
add name=DNS_capture
add exclude=NotNetFlow include=all name=NetFlow
/interface lte apn
set [ find default=yes ] ip-type=ipv4 use-network-apn=no
/interface wireless security-profiles
set [ find default=yes ] authentication-types=wpa2-psk eap-methods="" mode=dynamic-keys supplicant-identity=MikroTik wpa2-pre-shared-key=Amin@sapra
/ip pool
add name=dhcp_pool_LAN ranges=172.16.51.21-172.16.51.254
/ip dhcp-server
add address-pool=dhcp_pool_LAN interface=bridge-LAN lease-time=2d name=dhcp1
/ip smb users
set [ find default=yes ] disabled=yes
/ppp profile
add change-tcp-mss=yes name=HQ use-encryption=required
/interface l2tp-client
add allow-fast-path=yes connect-to=80.210.28.192 disabled=no ipsec-secret=S@pr4min max-mru=1500 max-mtu=1500 mrru=1600 name=l2tp-AHD-AF0-R4-RTR-01 password=BSH-AF1-R1-RTR-01 profile=HQ use-ipsec=yes user=BSH-AF1-R1-RTR-01
add allow-fast-path=yes connect-to=85.198.25.40 disabled=no ipsec-secret=S@pr4min max-mru=1500 max-mtu=1500 mrru=1600 name=l2tp-AHD-CF0-R1-RTR-01 password=BSH-AF1-R1-RTR-01 profile=HQ use-ipsec=yes user=BSH-AF1-R1-RTR-01
/routing id
add disabled=no id=172.31.1.128 name=id-1 select-dynamic-id=""
/routing ospf instance
add disabled=no name=default-v2 out-filter-chain=ospf-out redistribute=connected router-id=id-1
/routing ospf area
add disabled=no instance=default-v2 name=backbone-v2 nssa-translator=no
/routing table
add disabled=no fib name=onlyWANs
/snmp community
set [ find default=yes ] addresses=172.16.0.16/32,172.16.0.24/32 name=S@Pr4NMP
/system logging action
add name=syslog remote=172.16.0.20 remote-port=1514 src-address=172.30.24.1 target=remote
/interface bridge port
add bridge=bridge-LAN ingress-filtering=no interface=wlan1 internal-path-cost=10 path-cost=10
add bridge=bridge-LAN ingress-filtering=no interface=ether4 internal-path-cost=10 path-cost=10
add bridge=bridge-LAN ingress-filtering=no interface=ether3 internal-path-cost=10 path-cost=10
add bridge=bridge-LAN ingress-filtering=no interface=ether2 internal-path-cost=10 path-cost=10
add bridge=bridge-LAN ingress-filtering=no interface=ether1 internal-path-cost=10 path-cost=10
/ip firewall connection tracking
set udp-timeout=10s
/ip neighbor discovery-settings
set discover-interface-list=!dynamic
/ip settings
set max-neighbor-entries=8192
/ipv6 settings
set max-neighbor-entries=8192
/interface l2tp-server server
set allow-fast-path=yes default-profile=default enabled=yes ipsec-secret=1qw23er4 use-ipsec=yes
/interface list member
add interface=Radio list=NotNetFlow
add interface=ether5 list=NotNetFlow
add interface=bridge-LAN list=DNS_capture
/interface ovpn-server server
set auth=sha1,md5
/ip address
add address=172.30.24.1/24 interface=MGMT network=172.30.24.0
add address=172.31.1.128 interface=loopback1 network=172.31.1.128
add address=172.16.51.1/24 interface=bridge-LAN network=172.16.51.0
add address=172.31.0.53 interface=loopback53 network=172.31.0.53
add address=172.31.0.123 interface=loopback123 network=172.31.0.123
/ip arp
add address=192.168.30.5 interface=bridge-LAN mac-address=00:0C:29:BB:A1:E6
/ip dhcp-client
add disabled=yes interface=ether5
/ip dhcp-server network
add address=172.16.51.0/24 dns-server=172.16.0.11,172.31.0.53 gateway=172.16.51.1
/ip dns
set allow-remote-requests=yes servers=172.16.0.11
/ip dns static
add address=172.16.0.11 name=safeservice.local type=A
/ip firewall address-list
add address=85.198.25.40 list=HQ
add address=80.210.28.192 list=HQ
/ip firewall filter
add action=drop chain=forward comment="Drop invalid connections from WAN" connection-state=invalid in-interface=Radio
add action=drop chain=forward comment="Drop invalid connections to WAN" connection-state=invalid out-interface=Radio
add action=drop chain=input comment="Drop invalid input connections" connection-state=invalid
/ip firewall mangle
add action=mark-routing chain=output comment="HQ Tunnels PBR" dst-address-list=HQ new-routing-mark=onlyWANs passthrough=no
add action=change-mss chain=postrouting new-mss=1400 out-interface-list=*2000010 passthrough=yes protocol=tcp tcp-flags=syn tcp-mss=1401-65535
/ip firewall nat
add action=masquerade chain=srcnat out-interface=Radio
add action=redirect chain=dstnat comment="DNS Capture" disabled=yes dst-port=53 in-interface-list=DNS_capture protocol=udp
/ip firewall raw
add action=drop chain=prerouting comment="Drop DNS requests from the Internet" dst-port=53 in-interface=Radio protocol=udp
add action=drop chain=prerouting comment="Drop DNS requests from the Internet" dst-port=53 in-interface=Radio protocol=tcp
/ip firewall service-port
set ftp disabled=yes
set tftp disabled=yes
set h323 disabled=yes
set sip disabled=yes
set pptp disabled=yes
/ip ipsec profile
set [ find default=yes ] dpd-interval=2m dpd-maximum-failures=5
/ip route
add disabled=yes dst-address=192.168.99.0/24 gateway=*D
add disabled=no distance=1 dst-address=0.0.0.0/0 gateway=Radio pref-src=109.238.189.245 routing-table=main scope=30 suppress-hw-offload=no target-scope=10
add disabled=no distance=1 dst-address=0.0.0.0/0 gateway=Radio pref-src=109.238.189.245 routing-table=onlyWANs scope=30 suppress-hw-offload=no target-scope=10
/ip service
set telnet address=172.16.0.0/12
set ftp disabled=yes
set www disabled=yes
set api disabled=yes
set winbox port=8595
set api-ssl disabled=yes
/ip smb shares
set [ find default=yes ] directory=/pub
/ip traffic-flow
set active-flow-timeout=1m cache-entries=64k interfaces=NetFlow
/ip traffic-flow ipfix
set nat-dst-address=no nat-dst-port=no nat-src-address=no nat-src-port=no
/ip traffic-flow target
add dst-address=172.16.0.21 port=9995 src-address=172.30.24.1 version=ipfix
/ppp secret
add local-address=10.12.13.0 name=shahrouz password=MatatA remote-address=10.12.13.1
/routing bfd configuration
add disabled=no interfaces=l2tp-AHD-AF0-R4-RTR-01 min-rx=1s min-tx=1s multiplier=5
add disabled=no interfaces=l2tp-AHD-CF0-R1-RTR-01 min-rx=1s min-tx=1s multiplier=5
/routing filter rule
add chain=ospf-out comment="Management Subnet" disabled=no rule="if ( protocol connected && dst == 172.30.24.0/24 ) { accept }"
add chain=ospf-out comment=LAN disabled=no rule="if ( protocol connected && dst == 172.16.51.0/24 ) { accept }"
/routing ospf interface-template
add area=backbone-v2 auth=sha256 auth-id=1 auth-key=S@PR4m1N cost=110 disabled=no interfaces=l2tp-AHD-CF0-R1-RTR-01 networks=172.29.0.16/32 priority=1 type=ptp use-bfd=yes
add area=backbone-v2 auth=sha256 auth-id=1 auth-key=S@PR4m1N cost=100 disabled=no interfaces=l2tp-AHD-AF0-R4-RTR-01 networks=172.29.0.0/32 priority=1 type=ptp use-bfd=yes
/routing rule
add action=lookup-only-in-table disabled=no routing-mark=onlyWANs table=onlyWANs
/snmp
set contact=it@sapramin.com enabled=yes location="BSH AF1 [28.985278, 50.838333]" src-address=172.30.24.1
/system clock
set time-zone-autodetect=no time-zone-name=Asia/Tehran
/system identity
set name=BSH-AF1-R1-RTR-01
/system logging
add action=syslog topics=critical
add action=syslog topics=warning
add action=syslog topics=info
add action=syslog topics=error
/system note
set show-at-login=no
/system ntp client
set enabled=yes
/system ntp client servers
add address=time.windows.com
add address=time.google.com
add address=ir.pool.ntp.org
/system scheduler
add interval=1m name=DNS_Check on-event="/system script run DNS_Check" policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-time=startup
/system script
add dont-require-permissions=no name=DNS_Check owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source=":local PrimaryDNS \"172.16.0.11\";\r\n:local BackupDNS \"8.8.8.8,1.1.1.1,9.9.9.9\";\r\n:local TestDomain \"google.com\";\r\n\r\n:local ConfiguredDNS [/ip dns get servers];\r\n\r\n:if (\$ConfiguredDNS = \$PrimaryDNS) do={\r\n    :do {\r\n        /ip/firewall/nat/disable [find where comment=\"DNS Capture\"]\r\n        :put [:resolve \$TestDomain server \$PrimaryDNS];\r\n    } on-error={\r\n        log warning \"Primary DNS \$PrimaryDNS query failed. Setting \$BackupDNS as DNS servers\";\r\n        /ip dns set servers=\$BackupDNS;\r\n        /ip/firewall/nat/enable [find where comment=\"DNS Capture\"]\r\n    }\r\n} else={\r\n    :do {\r\n        :put [:resolve \$TestDomain server \$PrimaryDNS];\r\n        log warning \"Primary DNS \$PrimaryDNS is back online. Setting \$PrimaryDNS as DNS server\";\r\n        /ip dns set servers=\$PrimaryDNS;\r\n        /ip dns cache flush;\r\n    } on-error={ }\r\n}"
